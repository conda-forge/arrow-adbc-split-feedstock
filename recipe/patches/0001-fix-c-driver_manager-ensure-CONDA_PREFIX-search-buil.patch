From da67689b8b7b62e648a5706adc806dacb022eab6 Mon Sep 17 00:00:00 2001
From: David Li <li.davidm96@gmail.com>
Date: Mon, 15 Sep 2025 10:57:32 +0900
Subject: [PATCH] fix(c/driver_manager): ensure CONDA_PREFIX search builds

Closes #3427.
---
 .github/workflows/native-unix.yml            |  2 ++
 c/driver_manager/CMakeLists.txt              |  7 ++--
 c/driver_manager/adbc_driver_manager.cc      |  6 ++--
 c/driver_manager/adbc_driver_manager_test.cc | 37 +++++++++++++++++---
 go/adbc/drivermgr/adbc_driver_manager.cc     |  6 ++--
 5 files changed, 45 insertions(+), 13 deletions(-)

diff --git a/c/driver_manager/CMakeLists.txt b/c/driver_manager/CMakeLists.txt
index 64ba340a3..895cb13b2 100644
--- a/c/driver_manager/CMakeLists.txt
+++ b/c/driver_manager/CMakeLists.txt
@@ -70,9 +70,7 @@ foreach(LIB_TARGET ${ADBC_LIBRARIES})
                                      ${REPOSITORY_ROOT}/c/driver)
   target_compile_definitions(${LIB_TARGET} PRIVATE ADBC_EXPORTING)
   if("$ENV{CONDA_BUILD}" STREQUAL "1")
-    target_compile_definitions(${LIB_TARGET} PRIVATE ADBC_CONDA_BUILD=1)
-  else()
-    target_compile_definitions(${LIB_TARGET} PRIVATE ADBC_CONDA_BUILD=0)
+    target_compile_definitions(${LIB_TARGET} PRIVATE ADBC_CONDA_BUILD)
   endif()
 endforeach()
 
@@ -109,6 +107,9 @@ if(ADBC_BUILD_TESTS)
     target_compile_definitions(adbc-driver-manager-test
                                PRIVATE ADBC_DRIVER_MANAGER_TEST_MANIFEST_SYSTEM_LEVEL=1)
   endif()
+  if("$ENV{CONDA_BUILD}" STREQUAL "1")
+    target_compile_definitions(adbc-driver-manager-test PRIVATE ADBC_CONDA_BUILD)
+  endif()
   target_include_directories(adbc-driver-manager-test SYSTEM
                              PRIVATE ${REPOSITORY_ROOT}/c/ ${REPOSITORY_ROOT}/c/include/
                                      ${LIBPQ_INCLUDE_DIRS} ${REPOSITORY_ROOT}/c/driver)
diff --git a/c/driver_manager/adbc_driver_manager.cc b/c/driver_manager/adbc_driver_manager.cc
index 3169fd480..11145e1e6 100644
--- a/c/driver_manager/adbc_driver_manager.cc
+++ b/c/driver_manager/adbc_driver_manager.cc
@@ -720,7 +720,7 @@ struct ManagedLibrary {
         search_paths.emplace_back(SearchPathSource::kAdditional, path);
       }
 
-#if ADBC_CONDA_BUILD
+#if defined(ADBC_CONDA_BUILD)
       // Then, if this is a conda build, search in the conda environment if
       // it is activated.
       if (load_options & ADBC_LOAD_FLAG_SEARCH_ENV) {
@@ -731,7 +731,7 @@ struct ManagedLibrary {
 #endif  // _WIN32
         auto venv = GetEnvPaths(conda_name);
         if (!venv.empty()) {
-          for (const auto& venv_path : venv) {
+          for (const auto& [_, venv_path] : venv) {
             search_paths.emplace_back(SearchPathSource::kConda,
                                       venv_path / "etc" / "adbc" / "drivers");
           }
@@ -741,7 +741,7 @@ struct ManagedLibrary {
       if (load_options & ADBC_LOAD_FLAG_SEARCH_ENV) {
         search_paths.emplace_back(SearchPathSource::kDisabled, "Conda prefix");
       }
-#endif  // ADBC_CONDA_BUILD
+#endif  // defined(ADBC_CONDA_BUILD)
 
       auto status = SearchPathsForDriver(driver_path, search_paths, info, error);
       if (status != ADBC_STATUS_NOT_FOUND) {
-- 
2.48.1

